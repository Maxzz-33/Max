<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶å¤©æ°”é¢„æŠ¥ (Open-Meteo)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; display: flex; flex-direction: column; align-items: center; padding: 20px; text-align: center; }
        .container { background-color: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 800px; }
        h1 { color: #3498db; margin-bottom: 15px; }
        h2 { color: #333; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #e0e0e0; padding-bottom: 5px;}
        p { line-height: 1.6; }

        #location-info { margin-bottom: 20px; font-weight: bold; color: #555; }
        #error-message { color: red; margin-bottom: 20px; font-weight: bold; }

        .seven-day-forecast { margin-bottom: 30px; }
        .day-summary-container { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 10px; justify-content: flex-start; /* Changed for better scroll with many items */ }
        .day-summary { border: 1px solid #ddd; padding: 15px; border-radius: 8px; cursor: pointer; background-color: #f9f9f9; text-align: center; min-width: 120px; /* Increased min-width */ flex: 0 0 auto; transition: all 0.2s ease-in-out; }
        .day-summary:hover { background-color: #e9f5ff; border-color: #3498db; transform: translateY(-3px); }
        .day-summary.active { background-color: #3498db; color: white; border-color: #3498db; font-weight: bold; }
        .day-summary .date { font-size: 0.9em; color: #555; }
        .day-summary.active .date { color: #e0e0e0; }
        .day-summary .icon { font-size: 1.8em; margin: 8px 0; } /* Using text icons */
        .day-summary .temp { font-size: 0.95em; }

        .hourly-forecast { margin-top: 20px; border: 1px solid #ccc; padding: 20px; border-radius: 8px; background-color: #fdfdfd; }
        .hourly-forecast h2 { margin-top: 0; }
        .hourly-details-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
        .hour-detail { border: 1px solid #eee; padding: 10px; border-radius: 6px; background-color: #fff; text-align: center; }
        .hour-detail .time { font-weight: bold; font-size: 0.9em; }
        .hour-detail .icon { font-size: 1.5em; margin: 5px 0;} /* Using text icons */
        .hour-detail .temp { font-size: 1.1em; margin: 5px 0; }
        .hour-detail .weather { font-size: 0.8em; color: #666; word-wrap: break-word; }
        .hidden { display: none; }
        .loader {
            border: 5px solid #f3f3f3; 
            border-top: 5px solid #3498db; 
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>å®æ—¶å¤©æ°”é¢„æŠ¥ (Open-Meteo)</h1>
        <p id="instruction">æ­£åœ¨è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯...</p>
        <div id="loader" class="loader hidden"></div>
        <div id="error-message"></div>
        <div id="location-info"></div>

        <div id="weather-content" class="hidden">
            <div class="seven-day-forecast">
                <h2>æœªæ¥7å¤©å¤©æ°”</h2>
                <div id="seven-day-container" class="day-summary-container">
                    <!-- 7-day forecast will be populated by JavaScript -->
                </div>
            </div>

            <div id="hourly-forecast-section" class="hourly-forecast hidden">
                <h2 id="hourly-title">åˆ†æ—¶å¤©æ°”è¯¦æƒ…</h2>
                <div id="hourly-details-container" class="hourly-details-grid">
                    <!-- Hourly details will be populated by JavaScript -->
                </div>
            </div>
        </div>
         <p style="font-size: 0.8em; color: #777; margin-top: 20px;">å¤©æ°”æ•°æ®ç”± <a href="https://open-meteo.com/" target="_blank">Open-Meteo.com</a> æä¾›ã€‚</p>
    </div>

    <script>
        const instructionText = document.getElementById('instruction');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const locationInfo = document.getElementById('location-info');
        const weatherContent = document.getElementById('weather-content');
        const sevenDayContainer = document.getElementById('seven-day-container');
        const hourlyForecastSection = document.getElementById('hourly-forecast-section');
        const hourlyTitle = document.getElementById('hourly-title');
        const hourlyDetailsContainer = document.getElementById('hourly-details-container');

        let dailyWeatherDataStore = {}; // Store daily and associated hourly data
        let currentLatitude, currentLongitude;

        // WMO Weather interpretation codes mapping
        // Simplified, you can expand this with more icons and detailed Chinese descriptions
        function getWeatherInfoFromCode(code) {
            const weatherMap = {
                0: { description: 'æ™´æœ—', icon: 'â˜€ï¸' },
                1: { description: 'å°‘äº‘', icon: 'ğŸŒ¤ï¸' },
                2: { description: 'å±€éƒ¨å¤šäº‘', icon: 'ğŸŒ¥ï¸' },
                3: { description: 'é˜´å¤©', icon: 'â˜ï¸' },
                45: { description: 'é›¾', icon: 'ğŸŒ«ï¸' },
                48: { description: 'å†»é›¾', icon: 'ğŸŒ«ï¸â„ï¸' },
                51: { description: 'æ¯›æ¯›é›¨(å¼±)', icon: 'ğŸŒ¦ï¸' },
                53: { description: 'æ¯›æ¯›é›¨(ä¸­)', icon: 'ğŸŒ¦ï¸' },
                55: { description: 'æ¯›æ¯›é›¨(å¼º)', icon: 'ğŸŒ¦ï¸' },
                56: { description: 'å†»æ¯›æ¯›é›¨(å¼±)', icon: 'Sleet' },
                57: { description: 'å†»æ¯›æ¯›é›¨(å¼º)', icon: 'Sleet' },
                61: { description: 'å°é›¨', icon: 'ğŸŒ§ï¸' },
                63: { description: 'ä¸­é›¨', icon: 'ğŸŒ§ï¸' },
                65: { description: 'å¤§é›¨', icon: 'ğŸŒ§ï¸â˜”' },
                66: { description: 'å†»é›¨(å¼±)', icon: 'Sleet' },
                67: { description: 'å†»é›¨(å¼º)', icon: 'Sleet' },
                71: { description: 'å°é›ª', icon: 'ğŸŒ¨ï¸' },
                73: { description: 'ä¸­é›ª', icon: 'ğŸŒ¨ï¸' },
                75: { description: 'å¤§é›ª', icon: 'â„ï¸' },
                77: { description: 'ç±³é›ª', icon: 'â„ï¸' },
                80: { description: 'é˜µé›¨(å¼±)', icon: 'ğŸŒ¦ï¸' },
                81: { description: 'é˜µé›¨(ä¸­)', icon: 'ğŸŒ¦ï¸â˜”' },
                82: { description: 'é˜µé›¨(å¼º)', icon: 'â›ˆï¸' },
                85: { description: 'é˜µé›ª(å¼±)', icon: 'ğŸŒ¨ï¸' },
                86: { description: 'é˜µé›ª(å¼º)', icon: 'â„ï¸â˜ƒï¸' },
                95: { description: 'é›·æš´', icon: 'â›ˆï¸' }, // Slight/moderate
                96: { description: 'é›·æš´ä¼´æœ‰å°å†°é›¹', icon: 'â›ˆï¸ğŸ§Š' },
                99: { description: 'é›·æš´ä¼´æœ‰å¤§å†°é›¹', icon: 'â›ˆï¸ğŸ§Š' },
            };
            return weatherMap[code] || { description: 'æœªçŸ¥', icon: 'â“' };
        }

        function showLoader() {
            loader.classList.remove('hidden');
            instructionText.classList.add('hidden');
            weatherContent.classList.add('hidden');
            errorMessage.textContent = '';
        }

        function hideLoader() {
            loader.classList.add('hidden');
        }

        function showError(message) {
            hideLoader();
            errorMessage.textContent = message;
            instructionText.textContent = 'æ— æ³•åŠ è½½å¤©æ°”ä¿¡æ¯ã€‚';
            instructionText.classList.remove('hidden');
        }

        function displaySevenDayForecast(daily, hourlyTimes, hourlyTemperatures, hourlyWeatherCodes, timezone) {
            sevenDayContainer.innerHTML = '';
            dailyWeatherDataStore = {}; // Clear previous data

            daily.time.forEach((dateString, index) => {
                const date = new Date(dateString + 'T00:00:00'); // Ensure it parses as local date
                const dayName = index === 0 ? 'ä»Šå¤©' : date.toLocaleDateString('zh-CN', { weekday: 'short' });
                const formattedDate = date.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' });
                const weatherInfo = getWeatherInfoFromCode(daily.weathercode[index]);

                const dayData = {
                    date: formattedDate,
                    dayName: dayName,
                    high: daily.temperature_2m_max[index].toFixed(1) + 'Â°C',
                    low: daily.temperature_2m_min[index].toFixed(1) + 'Â°C',
                    weather: weatherInfo.description,
                    icon: weatherInfo.icon,
                    fullDate: dateString, // Store full date for filtering hourly data
                    hourly: [] // Initialize hourly array
                };

                // Filter and store hourly data for this day
                const dayStartEpoch = new Date(dateString + 'T00:00:00Z').getTime(); // UTC for comparison
                const dayEndEpoch = new Date(dateString + 'T23:59:59Z').getTime();

                for (let i = 0; i < hourlyTimes.length; i++) {
                    const hourlyTimeEpoch = new Date(hourlyTimes[i] + 'Z').getTime(); // API times are UTC
                    if (hourlyTimeEpoch >= dayStartEpoch && hourlyTimeEpoch <= dayEndEpoch) {
                        const hourWeatherInfo = getWeatherInfoFromCode(hourlyWeatherCodes[i]);
                        dayData.hourly.push({
                            time: new Date(hourlyTimes[i] + 'Z').toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: timezone }),
                            temp: hourlyTemperatures[i].toFixed(1) + 'Â°C',
                            weather: hourWeatherInfo.description,
                            icon: hourWeatherInfo.icon
                        });
                    }
                }
                dailyWeatherDataStore[dateString] = dayData;

                const dayElement = document.createElement('div');
                dayElement.classList.add('day-summary');
                dayElement.innerHTML = `
                    <div><strong>${dayData.dayName}</strong></div>
                    <div class="date">${dayData.date}</div>
                    <div class="icon">${dayData.icon}</div>
                    <div>${dayData.weather}</div>
                    <div class="temp">${dayData.low} / ${dayData.high}</div>
                `;
                dayElement.addEventListener('click', () => {
                    displayHourlyForecast(dateString);
                    document.querySelectorAll('.day-summary').forEach(el => el.classList.remove('active'));
                    dayElement.classList.add('active');
                });
                sevenDayContainer.appendChild(dayElement);
            });
            
            weatherContent.classList.remove('hidden');
            instructionText.classList.add('hidden');

            if (daily.time.length > 0) {
                displayHourlyForecast(daily.time[0]); // Display today's hourly by default
                const firstDayElement = sevenDayContainer.querySelector('.day-summary');
                if (firstDayElement) {
                    firstDayElement.classList.add('active');
                }
            }
        }

        function displayHourlyForecast(dateString) {
            const dayData = dailyWeatherDataStore[dateString];
            if (!dayData) {
                showError('æ— æ³•æ‰¾åˆ°é€‰å®šæ—¥æœŸçš„è¯¦ç»†ä¿¡æ¯ã€‚');
                hourlyForecastSection.classList.add('hidden');
                return;
            }

            hourlyTitle.textContent = `${dayData.dayName} (${dayData.date}) åˆ†æ—¶å¤©æ°”`;
            hourlyDetailsContainer.innerHTML = '';

            if (!dayData.hourly || dayData.hourly.length === 0) {
                hourlyDetailsContainer.innerHTML = '<p>è¯¥æ—¥æš‚æ— è¯¦ç»†åˆ†æ—¶æ•°æ®ã€‚</p>';
            } else {
                dayData.hourly.forEach(hourData => {
                    const hourElement = document.createElement('div');
                    hourElement.classList.add('hour-detail');
                    hourElement.innerHTML = `
                        <div class="time">${hourData.time}</div>
                        <div class="icon">${hourData.icon}</div>
                        <div class="temp">${hourData.temp}</div>
                        <div class="weather">${hourData.weather}</div>
                    `;
                    hourlyDetailsContainer.appendChild(hourElement);
                });
            }
            hourlyForecastSection.classList.remove('hidden');
        }

        async function fetchWeatherData(lat, lon) {
            currentLatitude = lat;
            currentLongitude = lon;
            showLoader();
            locationInfo.textContent = `çº¬åº¦: ${lat.toFixed(2)}, ç»åº¦: ${lon.toFixed(2)}`;
            
            // Open-Meteo API URL for 7-day daily forecast and hourly forecast for these days
            // We request temperature_2m_max, temperature_2m_min, weathercode for daily
            // And temperature_2m, weathercode for hourly.
            // `timezone=auto` tells Open-Meteo to use the timezone of the coordinates.
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&hourly=temperature_2m,weathercode&timeformat=iso8601&forecast_days=7&timezone=auto`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    showError(`è·å–å¤©æ°”æ•°æ®å¤±è´¥: ${response.status} ${response.statusText}`);
                    return;
                }
                const data = await response.json();
                console.log('Open-Meteo API Response:', data); // For debugging

                if (data.daily && data.daily.time && data.daily.time.length > 0 && data.hourly && data.hourly.time) {
                    hideLoader();
                    // Pass daily data, all hourly times, all hourly temps, all hourly codes, and the resolved timezone
                    displaySevenDayForecast(data.daily, data.hourly.time, data.hourly.temperature_2m, data.hourly.weathercode, data.timezone);
                } else {
                    showError('æœªæ‰¾åˆ°å®Œæ•´å¤©æ°”æ•°æ®ã€‚APIå“åº”å¯èƒ½ä¸å®Œæ•´æˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚è¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚');
                    console.error("API response missing expected daily or hourly data structure:", data);
                }
            } catch (error) {
                console.error('Fetch Weather Error:', error);
                showError('è¯·æ±‚å¤©æ°”æ•°æ®æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ã€‚');
            }
        }

        function getLocation() {
            if (navigator.geolocation) {
                instructionText.textContent = 'è¯·æ±‚æ‚¨çš„ä½ç½®æƒé™...è¯·åœ¨æµè§ˆå™¨æç¤ºä¸­å…è®¸ã€‚';
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        instructionText.textContent = 'ä½ç½®è·å–æˆåŠŸï¼Œæ­£åœ¨åŠ è½½å¤©æ°”æ•°æ®...';
                        fetchWeatherData(position.coords.latitude, position.coords.longitude);
                    },
                    (error) => {
                        let msg = 'è·å–åœ°ç†ä½ç½®å¤±è´¥: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                msg += "ç”¨æˆ·æ‹’ç»äº†åœ°ç†ä½ç½®è¯·æ±‚ã€‚è¯·å…è®¸ä½ç½®è®¿é—®ä»¥æŸ¥çœ‹å½“åœ°å¤©æ°”ã€‚";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                msg += "ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ã€‚";
                                break;
                            case error.TIMEOUT:
                                msg += "è·å–ä½ç½®ä¿¡æ¯è¶…æ—¶ã€‚";
                                break;
                            default:
                                msg += "å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚";
                                break;
                        }
                        showError(msg + ' æ‚¨å¯ä»¥å°è¯•åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥æµè§ˆå™¨ä½ç½®æƒé™è®¾ç½®ã€‚');
                    },
                    { timeout: 10000 } 
                );
            } else {
                showError("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½ã€‚æ— æ³•è·å–å®æ—¶å¤©æ°”ã€‚");
            }
        }

        getLocation();
    </script>
</body>
</html>